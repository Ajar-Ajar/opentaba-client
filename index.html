<!DOCTYPE html>
<html>
<head>
	<title>תב"ע בסבבה</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.ie.css" /><![endif]-->
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="css/stylesheet.css" rel="stylesheet" media="screen">

	<script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
	<script src="data/gushim.js"></script>

	<style>
		body {
			padding: 0;
			margin: 0;
		}
		html, body, #map {
			height: 100%;
		}
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span9">
				<div id="map" style="height: 800px;"></div>
			</div>
			<div class="span3">
				<div id="right-bar" style="font-family: Alef; direction: rtl;">
					<div id="header" style="text-align: center">
						<h1>תב"ע פתוחה</h1>
					</div>
					<div id="info" style="text-align: right">
						<p>ברוך בואך לתב"ע הפתוחה!</p>
						<p>בחרו גוש במפה כדי לצפות בתוכניות הבניה</p>
						<p style="margin-top:80%">פרויקט תב"ע פתוחה נועד על מנת לאפשר גישה נוחה לצבור למידע על תוכניות בניה. הפרויקט בנוי בקוד פתוח, גם את ואתה יכולים לתרום, 
							<a href="https://github.com/niryariv/citymap-server">בצד השרת</a> או <a href="https://github.com/niryariv/citymap-client">הממשק</a>.<!--  ליצירת קשר, פנו ל niryariv@gmail.com --></p>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script>

		var RUNNING_LOCAL = (document.location.host == 'localhost' || document.location.host == '127.0.0.1')

		var API_URL = RUNNING_LOCAL ? 'http://0.0.0.0:5000/' : 'http://enigmatic-peak-9169.herokuapp.com/';

		var map = L.map('map').setView([31.773, 35.18], 13);


		L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
		}).addTo(map);

		
		function render_plans(plans) {
			var out = "<h2>גוש " + plans[0].gush_id + " </h2>";

			out += "<table>";
			for (var i = 0 ; i<plans.length ; i++) {
				p = plans[i];

				out+="<tr class='item' style='vertical-align:top'>" +
					"	<td><b>" + [p.day, p.month, p.year].join("/") + "</b></td>" +
					"	<td>" + p.number + "</td><td>" + p.essence + "</td>" +
					"	<tr style='display:none'>" +
					"		<td colspan=3>" + p.status

				console.log(p.tasrit_link.length)
				for (var j = 0 ; j<p.tasrit_link.length ; j++)
					out += '	<a href="' + p.tasrit_link[j] + '"><i class="icon-folder-open"></i></a>'

				console.log(p.takanon_link.length)
				for (var j = 0 ; j<p.takanon_link.length ; j++)
					out += '	<a href="' + p.takanon_link[j] + '"><i class="icon-list"></i></a>'
						
				out+="		</td>" +
					 "	</tr>" +
					 "</tr>";
			}
			out += "</table>";

			$("#info").html(out);

			$("tr.item").hover(
	  			function () { $(this).css("background","#ddd"); }, 
	  			function () { $(this).css("background",""); }
			);

			$("tr.item").click(
	  			function () { $(this).next().toggle(); }
			);


		}

		function get_gush(gush_id) {
			$.getJSON(
				API_URL + 'gush/' + gush_id + '/plans',
				function(d) { render_plans(d); }
			)
		}

		function onEachFeature(feature, layer) {
			layer.bindPopup(feature.properties.Name + " גוש ");
			layer.on({
						'mouseover'	: function() { this.setStyle({ opacity: 0 	, color: "red" 	}) },
						'mouseout'	: function() { this.setStyle({ opacity: 0.95, color: "#333" }) },
						'click'		: function() { $("#info").html("עוד מעט...") ; get_gush(feature.properties.Name) }
					});
		}

		// samplefilter = function(f) { return f.properties.Name.substring(0,3) == "300" }
		// gushim = gushim.features.filter(samplefilter);

		// map.locate({setView: true, maxZoom: 16});
		L.geoJson(gushim,
			{
				onEachFeature: onEachFeature,
				style : {
					"color" : "#333",
					"weight": 1,
					"opacity": 0.95
				}
			}
		).addTo(map);

	</script>
<!- Jerusalem, winter 2013 -->
</body>
</html>
